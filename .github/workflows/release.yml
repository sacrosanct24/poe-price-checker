name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Tag to release (e.g., v1.2.3)'
        required: true
      release_ref:
        description: 'Git ref to build (branch, tag, or SHA)'
        required: false
        default: 'main'

permissions:
  contents: write

jobs:
  build-release:
    name: Build and Publish Release
    runs-on: windows-latest
    env:
      RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_tag || github.ref_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_ref || github.ref }}

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install runtime deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run unit tests only
        env:
          PYTEST_DISABLE_PLUGIN_AUTOLOAD: "1"
        run: |
          python -m pytest -m "unit and not gui and not slow" -q --durations=20 --ignore=tests/unit/gui_qt --ignore=tests/test_shortcuts.py -p pytest_mock

      - name: Build release artifact
        run: |
          python build.py --clean

      - name: Package artifact
        shell: pwsh
        run: |
          $artifact = "dist/PoEPriceChecker-windows-$env:RELEASE_TAG.zip"
          if (Test-Path $artifact) { Remove-Item $artifact }
          Compress-Archive -Path "dist/PoEPriceChecker/*" -DestinationPath $artifact

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          files: dist/PoEPriceChecker-windows-${{ env.RELEASE_TAG }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
